name: Android Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.5
      
    - name: Build Debug APK
      id: build_debug
      run: |
        gradle assembleDebug --stacktrace > build-debug.log 2>&1
        BUILD_STATUS=$?
        echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
        exit 0
      continue-on-error: true
      
    - name: Build Release APK
      id: build_release
      run: |
        gradle assembleRelease --stacktrace > build-release.log 2>&1
        BUILD_STATUS=$?
        echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
        exit 0
      continue-on-error: true
      
    - name: Extract compilation errors
      if: always()
      run: |
        echo "# Build Logs - Run #${{ github.run_number }}" > compilation-errors.md
        echo "" >> compilation-errors.md
        echo "**Repository:** ${{ github.repository }}" >> compilation-errors.md
        echo "**Branch:** ${{ github.ref_name }}" >> compilation-errors.md
        echo "**Commit:** \`${{ github.sha }}\`" >> compilation-errors.md
        echo "**Date:** $(date -u)" >> compilation-errors.md
        echo "" >> compilation-errors.md
        
        echo "## ğŸ› Debug Build" >> compilation-errors.md
        if [ "${{ steps.build_debug.outputs.status }}" = "0" ]; then
          echo "âœ… **Status:** SUCCESS" >> compilation-errors.md
        else
          echo "âŒ **Status:** FAILED" >> compilation-errors.md
          echo "" >> compilation-errors.md
          echo "### Errors:" >> compilation-errors.md
          echo '```' >> compilation-errors.md
          grep -A 5 -B 2 -E "error:|FAILED|FAILURE|Exception|Task.*failed" build-debug.log | head -200 >> compilation-errors.md || cat build-debug.log | head -100 >> compilation-errors.md
          echo '```' >> compilation-errors.md
        fi
        
        echo "" >> compilation-errors.md
        echo "## ğŸš€ Release Build" >> compilation-errors.md
        if [ "${{ steps.build_release.outputs.status }}" = "0" ]; then
          echo "âœ… **Status:** SUCCESS" >> compilation-errors.md
        else
          echo "âŒ **Status:** FAILED" >> compilation-errors.md
          echo "" >> compilation-errors.md
          echo "### Errors:" >> compilation-errors.md
          echo '```' >> compilation-errors.md
          grep -A 5 -B 2 -E "error:|FAILED|FAILURE|Exception|Task.*failed" build-release.log | head -200 >> compilation-errors.md || cat build-release.log | head -100 >> compilation-errors.md
          echo '```' >> compilation-errors.md
        fi
        
        echo "" >> compilation-errors.md
        echo "---" >> compilation-errors.md
        echo "## ğŸ“‹ Full Logs" >> compilation-errors.md
        echo "<details><summary>ğŸ› Debug Build Full Log (click to expand)</summary>" >> compilation-errors.md
        echo "" >> compilation-errors.md
        echo '```' >> compilation-errors.md
        cat build-debug.log >> compilation-errors.md
        echo '```' >> compilation-errors.md
        echo "</details>" >> compilation-errors.md
        
        echo "" >> compilation-errors.md
        echo "<details><summary>ğŸš€ Release Build Full Log (click to expand)</summary>" >> compilation-errors.md
        echo "" >> compilation-errors.md
        echo '```' >> compilation-errors.md
        cat build-release.log >> compilation-errors.md
        echo '```' >> compilation-errors.md
        echo "</details>" >> compilation-errors.md
        
    - name: Upload logs to GitHub Gist
      if: always()
      id: gist
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const content = fs.readFileSync('compilation-errors.md', 'utf8');
          
          try {
            const gist = await github.rest.gists.create({
              description: `Build logs for ${context.repo.owner}/${context.repo.repo} - Run #${context.runNumber}`,
              public: false,
              files: {
                'build-log.md': {
                  content: content
                }
              }
            });
            
            console.log(`ğŸ“ Build logs: ${gist.data.html_url}`);
            
            core.summary.addHeading('ğŸ“Š Build Summary', 2);
            core.summary.addRaw(`
            - ğŸ› Debug Build: ${'${{ steps.build_debug.outputs.status }}' === '0' ? 'âœ… SUCCESS' : 'âŒ FAILED'}
            - ğŸš€ Release Build: ${'${{ steps.build_release.outputs.status }}' === '0' ? 'âœ… SUCCESS' : 'âŒ FAILED'}
            `);
            core.summary.addLink('ğŸ“ View Full Build Logs', gist.data.html_url);
            await core.summary.write();
            
            return gist.data.html_url;
          } catch (error) {
            console.log('âš ï¸ Failed to create gist');
            console.log(content);
            return null;
          }
      
    - name: Find all APK files
      id: find_apks
      if: always()
      run: |
        echo "ğŸ” Searching for APK files..."
        find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found anywhere"
        
        mkdir -p apk-output
        
        # Ğ˜Ñ‰ĞµĞ¼ Ğ»ÑĞ±Ñ‹Ğµ APK Ğ² Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ
        DEBUG_APKS=$(find . -path "*/debug/*.apk" -type f 2>/dev/null)
        RELEASE_APKS=$(find . -path "*/release/*.apk" -type f 2>/dev/null)
        
        DEBUG_COUNT=0
        RELEASE_COUNT=0
        
        if [ -n "$DEBUG_APKS" ]; then
          echo "ğŸ“¦ Found Debug APKs:"
          echo "$DEBUG_APKS"
          for apk in $DEBUG_APKS; do
            cp "$apk" "apk-output/app-debug-v1.0.${{ github.run_number }}-$DEBUG_COUNT.apk"
            DEBUG_COUNT=$((DEBUG_COUNT + 1))
          done
          echo "debug_found=true" >> $GITHUB_OUTPUT
        else
          echo "debug_found=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$RELEASE_APKS" ]; then
          echo "ğŸ“¦ Found Release APKs:"
          echo "$RELEASE_APKS"
          for apk in $RELEASE_APKS; do
            cp "$apk" "apk-output/app-release-v1.0.${{ github.run_number }}-$RELEASE_COUNT.apk"
            RELEASE_COUNT=$((RELEASE_COUNT + 1))
          done
          echo "release_found=true" >> $GITHUB_OUTPUT
        else
          echo "release_found=false" >> $GITHUB_OUTPUT
        fi
        
        if [ $DEBUG_COUNT -gt 0 ] || [ $RELEASE_COUNT -gt 0 ]; then
          echo "any_apk=true" >> $GITHUB_OUTPUT
          echo "âœ… Total APKs found: $((DEBUG_COUNT + RELEASE_COUNT))"
          ls -lh apk-output/
        else
          echo "any_apk=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ No APK files found"
        fi
        
    - name: Create Release with APKs
      if: steps.find_apks.outputs.any_apk == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Release v1.0.${{ github.run_number }}
        body: |
          ## ğŸ“± Android Build - Run #${{ github.run_number }}
          
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          **Commit:** `${{ github.sha }}`
          **Branch:** `${{ github.ref_name }}`
          
          ### ğŸ“Š Build Status
          - ğŸ› Debug: ${{ steps.build_debug.outputs.status == '0' && 'âœ… Success' || 'âŒ Failed' }}
          - ğŸš€ Release: ${{ steps.build_release.outputs.status == '0' && 'âœ… Success' || 'âŒ Failed' }}
          
          ### ğŸ“¥ Downloads
          Download the APK files below
          
          ### ğŸ“² Installation
          1. Download the APK file
          2. Enable "Install from unknown sources" in Android settings
          3. Open the APK file to install
          
        files: apk-output/*.apk
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}