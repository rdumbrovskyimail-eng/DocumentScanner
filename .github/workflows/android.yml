name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Cache Gradle wrapper & dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Cache Android SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.android/build-cache
          ~/.android/cache
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-android-

    - name: Cache Kotlin compiler
      uses: actions/cache@v4
      with:
        path: |
          ~/.konan
          ~/.kotlin
        key: ${{ runner.os }}-kotlin-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-kotlin-

    - name: Setup Gradle (—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π)
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-home-cache-cleanup: true
        cache-read-only: false
        cache-write-only: false
        add-job-summary: always
        build-scan-publish: true
        build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
        build-scan-terms-of-use-agree: "yes"

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle (Single Pass)
      id: build
      run: |
        FULL_LOG="build_full.log"
        ERRORS_FILE="build_errors.txt"
        
        echo "üöÄ Starting optimized build..."
        echo "üìä Memory before build:"
        free -h
        echo ""
        
        # ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –í–ï–°–¨ –≤—ã–≤–æ–¥
        set +e
        ./gradlew assembleDebug \
          --stacktrace \
          --no-daemon \
          --max-workers=4 \
          --build-cache \
          --configuration-cache \
          --no-watch-fs \
          --info \
          2>&1 | tee "$FULL_LOG"
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        echo ""
        echo "üìä Memory after build:"
        free -h
        echo ""
        echo "üîç Build exit code: $BUILD_EXIT_CODE"
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # COMPREHENSIVE ERROR EXTRACTION
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        {
          echo "==============================================================="
          echo "  BUILD REPORT - $(date '+%Y-%m-%d %H:%M:%S')"
          echo "  Commit: $(git rev-parse --short HEAD)"
          echo "  Exit code: $BUILD_EXIT_CODE"
          echo "==============================================================="
          echo ""
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º SUCCESS/FAILURE –≤ –ª–æ–≥–µ
          if grep -q "BUILD SUCCESSFUL" "$FULL_LOG"; then
            echo "‚úÖ BUILD SUCCESSFUL"
          elif grep -q "BUILD FAILED" "$FULL_LOG"; then
            echo "‚ùå BUILD FAILED"
          else
            echo "‚ö†Ô∏è  BUILD STATUS UNKNOWN (exit code: $BUILD_EXIT_CODE)"
          fi
          
          echo ""
          echo ">>> KOTLIN COMPILATION ERRORS:"
          if grep -E "^e: " "$FULL_LOG" 2>/dev/null | head -50; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo ">>> JAVA COMPILATION ERRORS:"
          if grep -E "^.*\.java:[0-9]+: error:" "$FULL_LOG" 2>/dev/null | head -50; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo ">>> UNRESOLVED REFERENCES:"
          if grep -i "unresolved reference" "$FULL_LOG" 2>/dev/null | head -30; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo ">>> GRADLE FAILURE DETAILS:"
          if grep -A 30 "^FAILURE:" "$FULL_LOG" 2>/dev/null; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo ">>> TASK FAILURES:"
          if grep -E "> Task .* FAILED" "$FULL_LOG" 2>/dev/null; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo ">>> EXCEPTIONS & STACK TRACES:"
          if grep -B 2 -A 10 -E "Exception|at [a-z]+\.[a-z]+\." "$FULL_LOG" 2>/dev/null | grep -v "HeapDumpOnOutOfMemoryError" | head -100; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo ">>> DEPENDENCY RESOLUTION ERRORS:"
          if grep -iE "could not (resolve|find|determine)|dependency.*failed" "$FULL_LOG" 2>/dev/null | head -30; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo ">>> MANIFEST ERRORS:"
          if grep -iE "manifest|androidmanifest" "$FULL_LOG" 2>/dev/null | grep -i error | head -20; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo ">>> RESOURCE ERRORS:"
          if grep -E "AAPT.*error|resource.*error" "$FULL_LOG" 2>/dev/null | head -30; then
            :
          else
            echo "  (none)"
          fi
          
          echo ""
          echo "==============================================================="
          echo "  LAST 100 LINES OF BUILD LOG:"
          echo "==============================================================="
          tail -100 "$FULL_LOG"
          
        } > "$ERRORS_FILE"
        
        # –ü–æ–¥—Å—á—ë—Ç –æ—à–∏–±–æ–∫ (–±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π) - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º || echo "0"
        KOTLIN_ERRORS=$(grep -cE "^e: " "$FULL_LOG" 2>/dev/null || echo "0")
        JAVA_ERRORS=$(grep -cE "^.*\.java:[0-9]+: error:" "$FULL_LOG" 2>/dev/null || echo "0")
        TASK_FAILURES=$(grep -cE "> Task .* FAILED" "$FULL_LOG" 2>/dev/null || echo "0")
        
        TOTAL_ERRORS=$((KOTLIN_ERRORS + JAVA_ERRORS + TASK_FAILURES))
        
        # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        {
          echo "error_count=${TOTAL_ERRORS}"
          echo "kotlin_errors=${KOTLIN_ERRORS}"
          echo "java_errors=${JAVA_ERRORS}"
          echo "task_failures=${TASK_FAILURES}"
        } >> "$GITHUB_OUTPUT"
        
        # ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏
        if [ $BUILD_EXIT_CODE -eq 0 ] && grep -q "BUILD SUCCESSFUL" "$FULL_LOG"; then
          echo "build_status=success" >> "$GITHUB_OUTPUT"
          echo ""
          echo "‚úÖ BUILD SUCCESSFUL!"
        else
          echo "build_status=failure" >> "$GITHUB_OUTPUT"
          echo ""
          echo "‚ùå BUILD FAILED!"
          echo "   Exit code: $BUILD_EXIT_CODE"
          echo "   Kotlin errors: $KOTLIN_ERRORS"
          echo "   Java errors: $JAVA_ERRORS"
          echo "   Failed tasks: $TASK_FAILURES"
        fi

    - name: Diagnose APK location
      if: always()
      run: |
        echo "üîç Searching for all APK files..."
        find . -name "*.apk" -type f -exec ls -lh {} \; || echo "No APK files found"
        
        echo ""
        echo "üìÇ Checking standard debug APK directory..."
        ls -lah app/build/outputs/apk/debug/ 2>/dev/null || echo "Directory app/build/outputs/apk/debug/ not found"
        
        echo ""
        echo "üìÇ Searching for all 'outputs' directories..."
        find . -type d -name "outputs" -exec ls -la {} \; 2>/dev/null || echo "No outputs directories found"

    - name: Upload debug APK artifact
      if: steps.build.outputs.build_status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-${{ github.sha }}
        path: |
          app/build/outputs/apk/debug/*.apk
          **/build/outputs/apk/debug/*.apk
        if-no-files-found: warn
        retention-days: 14

    - name: Upload ALL logs (full + errors)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          build_full.log
          build_errors.txt
        retention-days: 7

    - name: Get commit info
      if: always()
      id: commit
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        echo "message=${COMMIT_MSG}" >> $GITHUB_OUTPUT
        echo "author=${COMMIT_AUTHOR}" >> $GITHUB_OUTPUT

    - name: Send Success Notification to Telegram
      if: steps.build.outputs.build_status == 'success' && github.event_name == 'push'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" -type f | head -1)
        APK_NAME=$(basename "$APK_PATH")
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        
        MESSAGE="‚úÖ <b>Build Successful!</b>%0A%0A"
        MESSAGE+="üì± <b>APK:</b> ${APK_NAME}%0A"
        MESSAGE+="üì¶ <b>Size:</b> ${APK_SIZE}%0A"
        MESSAGE+="üë§ <b>Author:</b> ${{ steps.commit.outputs.author }}%0A"
        MESSAGE+="üí¨ <b>Commit:</b> ${{ steps.commit.outputs.message }}%0A"
        MESSAGE+="üîó <b>SHA:</b> <code>${GITHUB_SHA:0:7}</code>%0A%0A"
        MESSAGE+="üì• <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Download APK</a>"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="HTML" \
          -d disable_web_page_preview=true

    - name: Send Build Failure with Errors to Telegram
      if: steps.build.outputs.build_status == 'failure' && github.event_name == 'push'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="‚ùå <b>Build Failed!</b>%0A%0A"
        MESSAGE+="üë§ <b>Author:</b> ${{ steps.commit.outputs.author }}%0A"
        MESSAGE+="üí¨ <b>Commit:</b> ${{ steps.commit.outputs.message }}%0A"
        MESSAGE+="üîó <b>SHA:</b> <code>${GITHUB_SHA:0:7}</code>%0A%0A"
        MESSAGE+="üêõ <b>Errors Found:</b>%0A"
        MESSAGE+="   ‚Ä¢ Kotlin: ${{ steps.build.outputs.kotlin_errors }}%0A"
        MESSAGE+="   ‚Ä¢ Java: ${{ steps.build.outputs.java_errors }}%0A"
        MESSAGE+="   ‚Ä¢ Tasks: ${{ steps.build.outputs.task_failures }}%0A%0A"
        MESSAGE+="üìã <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Details</a>"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="HTML" \
          -d disable_web_page_preview=true
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª —Å –æ—à–∏–±–∫–∞–º–∏ –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç
        if [ -f "build_errors.txt" ]; then
          ERROR_SUMMARY="K:${{ steps.build.outputs.kotlin_errors }} J:${{ steps.build.outputs.java_errors }} T:${{ steps.build.outputs.task_failures }}"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
            -F chat_id="${TELEGRAM_CHAT_ID}" \
            -F document=@build_errors.txt \
            -F caption="üìÑ Build Error Report (${ERROR_SUMMARY})"
        fi

    - name: Fail job if build failed
      if: steps.build.outputs.build_status == 'failure'
      run: |
        echo "::error::Build failed with ${{ steps.build.outputs.error_count }} errors"
        exit 1