name: Android CI (Smart Logs)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
    
    # âœ… ÐÐžÐ’ÐžÐ•: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÐµÑˆÐ° Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸
    - name: Clear Gradle Cache (on cache corruption)
      if: github.event_name == 'push' && contains(github.event.head_commit.message, '[clear-cache]')
      run: |
        echo "ðŸ§¹ Clearing Gradle caches..."
        rm -rf ~/.gradle/caches
        rm -rf ~/.gradle/wrapper
        rm -rf ~/.konan
        rm -rf .gradle
        rm -rf build-cache
        echo "âœ… Caches cleared"
    
    - name: Cache Gradle Wrapper
      uses: actions/cache@v4
      with:
        path: ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: ${{ runner.os }}-gradle-wrapper-
    
    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/daemon
          ~/.konan
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
        restore-keys: ${{ runner.os }}-gradle-
    
    - name: Cache Build Output
      uses: actions/cache@v4
      with:
        path: |
          build-cache
          .gradle
          app/build
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: ${{ runner.os }}-build-
    
    - name: Configure Gradle
      run: |
        mkdir -p $HOME/.gradle
        cat > $HOME/.gradle/gradle.properties << EOF
        org.gradle.caching=true
        org.gradle.parallel=true
        org.gradle.daemon=true
        org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1536m -XX:+UseG1GC
        org.gradle.configuration-cache=true
        org.gradle.vfs.watch=true
        android.useAndroidX=true
        kotlin.incremental=true
        EOF
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    # âœ… Ð£Ð›Ð£Ð§Ð¨Ð•ÐÐž: Ð‘Ð¾Ð»ÐµÐµ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ°
    - name: Clean build
      run: |
        echo "ðŸ§¹ Deep cleaning..."
        ./gradlew clean --no-daemon --stacktrace
        ./gradlew cleanBuildCache --no-daemon || true
        rm -rf app/build
        rm -rf build
        echo "âœ… Clean completed"
    
    # âœ… ÐÐžÐ’ÐžÐ•: Build Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
    - name: Build APKs with Error Logging
      id: build
      run: |
        set +e  # ÐÐµ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒÑÑ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐµ
        
        echo "ðŸ”¨ Starting build..."
        
        # ÐŸÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ Ð² Ñ„Ð°Ð¹Ð»
        ./gradlew assembleDebug assembleRelease \
          --parallel \
          --build-cache \
          --configuration-cache \
          --max-workers=4 \
          --stacktrace \
          -Dorg.gradle.workers.max=4 \
          -Dkotlin.compiler.execution.strategy=in-process \
          > build.log 2>&1
        
        BUILD_EXIT_CODE=$?
        
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "âŒ Build failed with exit code $BUILD_EXIT_CODE"
          echo "build_status=failed" >> $GITHUB_OUTPUT
          
          # âœ… Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¢ÐžÐ›Ð¬ÐšÐž ÐžÐ¨Ð˜Ð‘ÐšÐ˜ Ð¸Ð· Ð»Ð¾Ð³Ð°
          echo "## ðŸ”´ Compilation Errors" > errors.txt
          echo "" >> errors.txt
          
          # KSP Ð¾ÑˆÐ¸Ð±ÐºÐ¸
          grep -A 5 "e: \[ksp\]" build.log >> errors.txt 2>/dev/null || true
          
          # Kotlin compilation errors
          grep -A 3 "e: file://" build.log >> errors.txt 2>/dev/null || true
          
          # Task failed
          grep -A 10 "Task.*failed" build.log >> errors.txt 2>/dev/null || true
          
          # Execution failed
          grep -B 3 -A 5 "Execution failed for task" build.log >> errors.txt 2>/dev/null || true
          
          # FAILURE: Build failed
          grep -A 20 "FAILURE: Build failed" build.log >> errors.txt 2>/dev/null || true
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº
          ERROR_COUNT=$(grep -c "^e:" build.log 2>/dev/null || echo "0")
          echo "ðŸ“Š Found $ERROR_COUNT error lines"
          
          # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð² ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ GitHub Actions
          echo "### âŒ Build Failed"
          echo ""
          echo "\`\`\`"
          head -n 100 errors.txt
          echo "\`\`\`"
          
          exit 1
        else
          echo "âœ… Build successful"
          echo "build_status=success" >> $GITHUB_OUTPUT
        fi
    
    # âœ… ÐÐžÐ’ÐžÐ•: Upload Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¾Ð³Ð¾Ð² Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ð¼Ð¸ (ÐµÑÐ»Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ° ÑƒÐ¿Ð°Ð»Ð°)
    - name: Upload Error Logs
      if: failure() && steps.build.outputs.build_status == 'failed'
      uses: actions/upload-artifact@v4
      with:
        name: build-error-logs
        path: |
          errors.txt
          build/reports/kotlin-build/*.txt
        retention-days: 7
        if-no-files-found: ignore
    
    # âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… APK
    - name: Verify Build Output
      if: success()
      run: |
        echo "ðŸ“¦ Checking built APKs..."
        find app/build/outputs/apk -type f -name "*.apk" -exec ls -lh {} \;
    
    # âœ… ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° APK Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
    - name: Prepare APKs for Release
      if: success()
      run: |
        mkdir -p apks
        
        # Debug APK
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          cp app/build/outputs/apk/debug/app-debug.apk \
             apks/DocumentScanner-v${{ github.run_number }}-debug.apk
          echo "âœ… Debug: $(ls -lh apks/DocumentScanner-v${{ github.run_number }}-debug.apk | awk '{print $5}')"
        fi
        
        # Release APK
        RELEASE_APK=""
        if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          RELEASE_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
        elif [ -f app/build/outputs/apk/release/app-release.apk ]; then
          RELEASE_APK="app/build/outputs/apk/release/app-release.apk"
        fi
        
        if [ -n "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" apks/DocumentScanner-v${{ github.run_number }}-release.apk
          echo "âœ… Release: $(ls -lh apks/DocumentScanner-v${{ github.run_number }}-release.apk | awk '{print $5}')"
        fi
        
        ls -lh apks/
    
    # âœ… Upload APK (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐµ)
    - name: Upload APK Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: apk-builds
        path: apks/*.apk
        retention-days: 7
    
    # âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð°
    - name: Create Release
      if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: DocumentScanner v1.0.${{ github.run_number }}
        body: |
          ## ðŸ“± DocumentScanner v1.0.${{ github.run_number }}
          
          ### âš¡ Build Info
          - **Commit:** `${{ github.sha }}`
          - **Branch:** `${{ github.ref_name }}`
          - **Build #:** ${{ github.run_number }}
          - **Gradle:** 8.11.1
          - **JDK:** 21
          
          ### ðŸ“¥ Installation
          1. Download APK
          2. Uninstall old version
          3. Install new APK
          4. Enable "Unknown sources" if needed
          
          ### ðŸ“¦ Available Versions
          - **Debug APK** - with debug info
          - **Release APK** - optimized (R8/ProGuard)
          
        files: apks/*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # âœ… Ð£Ð›Ð£Ð§Ð¨Ð•ÐÐž: Cleanup Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¾Ð¹ ÐºÐµÑˆÐ°
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Stopping Gradle daemon..."
        ./gradlew --stop || true
        
        # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        rm -rf /tmp/gradle* 2>/dev/null || true
        rm -rf /tmp/kotlin* 2>/dev/null || true
        
        echo "âœ… Cleanup completed"