Name: Android CI

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±–Ω–æ–≤–∏–ª–∏ JDK –¥–æ 21 –≤–µ—Ä—Å–∏–∏
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.11.1
      
    - name: Build Debug APK
      run: gradle assembleDebug --stacktrace
      
    - name: Build Release APK
      run: gradle assembleRelease --stacktrace
      continue-on-error: true
      
    - name: Prepare APKs
      run: |
        mkdir -p apks
        
        # Debug APK (–≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å)
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          cp app/build/outputs/apk/debug/app-debug.apk apks/DocumentScanner-v${{ github.run_number }}-debug.apk
          echo "‚úÖ Debug APK –≥–æ—Ç–æ–≤"
        fi
        
        # Release APK (–º–æ–∂–µ—Ç –Ω–µ —Å–æ–±—Ä–∞—Ç—å—Å—è –±–µ–∑ –∫–ª—é—á–∞)
        if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          cp app/build/outputs/apk/release/app-release-unsigned.apk apks/DocumentScanner-v${{ github.run_number }}-release.apk
          echo "‚úÖ Release APK –≥–æ—Ç–æ–≤"
        elif [ -f app/build/outputs/apk/release/app-release.apk ]; then
          cp app/build/outputs/apk/release/app-release.apk apks/DocumentScanner-v${{ github.run_number }}-release.apk
          echo "‚úÖ Release APK –≥–æ—Ç–æ–≤"
        else
          echo "‚ö†Ô∏è Release APK –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
        
        echo ""
        echo "üì¶ –ì–æ—Ç–æ–≤—ã–µ APK —Ñ–∞–π–ª—ã:"
        ls -lh apks/
      
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: DocumentScanner v1.0.${{ github.run_number }}
        body: |
          ## üì± DocumentScanner v1.0.${{ github.run_number }}
          
          ### üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          1. –°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª
          2. **–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
          3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
          4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª—é—á–∏—Ç–µ "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
          
          ### üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
          - **Debug APK** - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏
          - **Release APK** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
          
          ### üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
          - **Commit:** `${{ github.sha }}`
          - **Branch:** `${{ github.ref_name }}`
          - **Build:** #${{ github.run_number }}
          
        files: apks/*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
