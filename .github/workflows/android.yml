name: Android CI (Optimized)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

# ÐžÑ‚Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ¸ Ð´Ð»Ñ Ñ‚Ð¾Ð³Ð¾ Ð¶Ðµ PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4
      with:
        # Shallow clone Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ
        fetch-depth: 1
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
    
    # âœ… Gradle Wrapper ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
    - name: Cache Gradle Wrapper
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-wrapper-
    
    # âœ… Gradle Dependencies ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/daemon
          ~/.konan
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # âœ… Build Cache
    - name: Cache Build Output
      uses: actions/cache@v4
      with:
        path: |
          build-cache
          .gradle
          app/build
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-
    
    # âœ… Gradle Build Cache ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
    - name: Configure Gradle Build Cache
      run: |
        mkdir -p $HOME/.gradle
        cat > $HOME/.gradle/gradle.properties << EOF
        org.gradle.caching=true
        org.gradle.parallel=true
        org.gradle.daemon=true
        org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1536m -XX:+UseG1GC
        org.gradle.configuration-cache=true
        org.gradle.vfs.watch=true
        android.useAndroidX=true
        kotlin.incremental=true
        EOF
    
    # âœ… Gradle Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    # âœ… ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: ÐžÐ´Ð¸Ð½ clean Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº
    - name: Clean build (once)
      run: ./gradlew clean --no-daemon --stacktrace
    
    # âœ… Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Debug Ð¸ Release ÐŸÐÐ ÐÐ›Ð›Ð•Ð›Ð¬ÐÐž
    - name: Build APKs (Parallel)
      run: |
        ./gradlew assembleDebug assembleRelease \
          --parallel \
          --build-cache \
          --configuration-cache \
          --max-workers=4 \
          --stacktrace \
          -Dorg.gradle.workers.max=4 \
          -Dkotlin.compiler.execution.strategy=in-process
      continue-on-error: true
      
    # âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸
    - name: Verify Build Output
      run: |
        echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… APK..."
        find app/build/outputs/apk -type f -name "*.apk" -exec ls -lh {} \;
      
    - name: Prepare APKs for Release
      run: |
        mkdir -p apks
        
        # Debug APK
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          cp app/build/outputs/apk/debug/app-debug.apk \
             apks/DocumentScanner-v${{ github.run_number }}-debug.apk
          echo "âœ… Debug APK: $(ls -lh apks/DocumentScanner-v${{ github.run_number }}-debug.apk | awk '{print $5}')"
        fi
        
        # Release APK (unsigned or signed)
        RELEASE_APK=""
        if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          RELEASE_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
        elif [ -f app/build/outputs/apk/release/app-release.apk ]; then
          RELEASE_APK="app/build/outputs/apk/release/app-release.apk"
        fi
        
        if [ -n "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" apks/DocumentScanner-v${{ github.run_number }}-release.apk
          echo "âœ… Release APK: $(ls -lh apks/DocumentScanner-v${{ github.run_number }}-release.apk | awk '{print $5}')"
        else
          echo "âš ï¸ Release APK Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        fi
        
        echo ""
        echo "ðŸ“¦ Ð’ÑÐµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:"
        ls -lh apks/ || echo "ÐÐµÑ‚ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² apks/"
    
    # âœ… Upload Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² (Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸, ÐµÑÐ»Ð¸ Ñ€ÐµÐ»Ð¸Ð· Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½)
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: apk-builds
        path: apks/*.apk
        retention-days: 7
      
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: DocumentScanner v1.0.${{ github.run_number }}
        body: |
          ## ðŸ“± DocumentScanner v1.0.${{ github.run_number }}
          
          ### âš¡ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ°
          - ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Debug + Release
          - Gradle Build Cache Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½
          - Configuration Cache Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½
          
          ### ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
          1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ APK Ñ„Ð°Ð¹Ð»
          2. **Ð£Ð´Ð°Ð»Ð¸Ñ‚Ðµ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ** (Settings â†’ Apps â†’ DocumentScanner â†’ Uninstall)
          3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
          4. ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸: Settings â†’ Security â†’ Enable "Unknown sources"
          
          ### ðŸ“¦ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸
          - **Debug APK** - Ñ Ð¾Ñ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹
          - **Release APK** - Ð¼Ð¸Ð½Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ (ProGuard/R8)
          
          ### ðŸ“ Build Info
          - **Commit:** `${{ github.sha }}`
          - **Branch:** `${{ github.ref_name }}`
          - **Build #:** ${{ github.run_number }}
          - **Gradle:** 8.11.1
          - **JDK:** 21
          
        files: apks/*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ ÑÐ±Ð¾Ñ€ÐºÐ¸
    - name: Cleanup Gradle Daemon
      if: always()
      run: |
        ./gradlew --stop || true