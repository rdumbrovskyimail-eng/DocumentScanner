name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
    
    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Gradle
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'buildSrc/**/*.kt') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Kotlin
    - name: Cache Kotlin/Native
      uses: actions/cache@v4
      with:
        path: |
          ~/.konan
        key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-konan-
    
    # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò–∑–º–µ–Ω—ë–Ω –∫–ª—é—á –∫—ç—à–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ä–æ–≥–æ –±–∏–ª–¥–∞
    - name: Cache build outputs
      uses: actions/cache@v4
      with:
        path: |
          app/build
          build
        key: ${{ runner.os }}-build-v2-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-v2-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Kotlin —Ñ–∞–π–ª–æ–≤
    - name: Clean build if needed
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -E '(\.kt$|backup_rules\.xml|data_extraction_rules\.xml|proguard-rules\.pro|build\.gradle)'; then
          echo "üßπ Critical files changed, cleaning build..."
          ./gradlew clean
        else
          echo "‚úÖ No critical files changed, using cache"
        fi
    
    # –°–±–æ—Ä–∫–∞ DEBUG APK (–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π debug-–∫–ª—é—á–æ–º)
    - name: Build Debug APK
      id: build
      continue-on-error: true
      run: |
        set +e
        echo "üî® Building with debug signing..."
        ./gradlew assembleDebug --stacktrace --no-daemon --warning-mode all 2>&1 | tee build_log.txt
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        echo "build_exit_code=$BUILD_EXIT_CODE" >> $GITHUB_OUTPUT
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Build successful!"
        else
          echo "‚ùå Build failed with exit code $BUILD_EXIT_CODE"
        fi
        
        exit $BUILD_EXIT_CODE
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –∏–∑ –ª–æ–≥–∞
    - name: Extract errors
      if: always()
      run: |
        if [ -f build_log.txt ]; then
          echo "## üîç Build Errors Summary" > build_errors.txt
          echo "" >> build_errors.txt
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
          grep -A 5 "^> Task.*FAILED$" build_log.txt >> build_errors.txt 2>/dev/null || true
          grep -A 15 "FAILURE: Build failed" build_log.txt >> build_errors.txt 2>/dev/null || true
          grep -A 3 "Error:" build_log.txt >> build_errors.txt 2>/dev/null || true
          
          # Signing –æ—à–∏–±–∫–∏
          if grep -q "SigningConfig" build_log.txt; then
            echo "" >> build_errors.txt
            echo "## üîë Signing Errors" >> build_errors.txt
            grep -A 5 "SigningConfig" build_log.txt >> build_errors.txt 2>/dev/null || true
          fi
          
          # Lint –æ—à–∏–±–∫–∏
          if grep -q "lintVitalRelease FAILED" build_log.txt; then
            echo "" >> build_errors.txt
            echo "## üìã Lint Errors" >> build_errors.txt
            grep -A 20 "Error:" build_log.txt | grep -E "(Error:|Explanation)" >> build_errors.txt 2>/dev/null || true
          fi
          
          # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç–æ–π, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–± —É—Å–ø–µ—Ö–µ
          if [ ! -s build_errors.txt ]; then
            echo "‚úÖ No errors found - Build successful!" > build_errors.txt
          fi
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É
          echo "üìä Build Summary:"
          tail -20 build_errors.txt
        fi
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build_log.txt
          build_errors.txt
          app/build/reports/
          app/build/outputs/logs/
        retention-days: 7
    
    # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –æ—à–∏–±–∫–∞–º–∏ –≤ PR
    - name: Comment PR with errors
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let errorContent = '‚ùå **Build Failed**\n\n';
          
          if (fs.existsSync('build_errors.txt')) {
            const errors = fs.readFileSync('build_errors.txt', 'utf8');
            errorContent += '```\n' + errors.substring(0, 60000) + '\n```\n';
            errorContent += '\nüì• Full logs available in [artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: errorContent
          });
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—Ö–∞ —Å–±–æ—Ä–∫–∏
    - name: Check build status
      if: steps.build.outputs.build_exit_code != '0'
      run: |
        echo "‚ùå Build failed with exit code ${{ steps.build.outputs.build_exit_code }}"
        echo "üìã Check build_errors.txt in artifacts for details"
        cat build_errors.txt
        exit 1
    
    # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã APK
    - name: Debug APK location
      if: always()
      run: |
        echo "üîç Searching for APK files..."
        find app/build/outputs -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
        echo ""
        echo "üìÇ Directory structure:"
        ls -lhR app/build/outputs/apk/ 2>/dev/null || echo "APK directory doesn't exist"
    
    - name: Prepare APKs for Release
      if: success()
      run: |
        mkdir -p apks
        
        # –ò—â–µ–º debug APK (–æ–Ω —Ç–æ—á–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω)
        DEBUG_APK=""
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          DEBUG_APK="app/build/outputs/apk/debug/app-debug.apk"
          echo "‚úÖ Found debug APK"
        fi
        
        if [ -n "$DEBUG_APK" ]; then
          cp "$DEBUG_APK" apks/DocumentScanner-v${{ github.run_number }}-debug.apk
          echo "‚úÖ APK prepared: DocumentScanner-v${{ github.run_number }}-debug.apk"
          ls -lh apks/
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± APK
          echo ""
          echo "üì¶ APK Info:"
          file apks/DocumentScanner-v${{ github.run_number }}-debug.apk
        else
          echo "‚ö†Ô∏è No APK found in expected locations"
          echo "Searching everywhere..."
          find . -name "*.apk" -type f
          exit 1
        fi
    
    - name: Create Release
      if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: DocumentScanner v1.0.${{ github.run_number }}
        body: |
          ## üì± DocumentScanner v1.0.${{ github.run_number }}
          
          **‚ö†Ô∏è Debug Build** - Signed with debug keystore (for testing only)
          
          **Commit:** `${{ github.sha }}`
          **Build #:** ${{ github.run_number }}
          **Build time:** Optimized with caching
          
          ### üì¶ Downloads
          - Debug APK included below (installable for testing)
          
          ### üîß Changes
          ${{ github.event.head_commit.message }}
          
          ### ‚ÑπÔ∏è Note
          This is a debug build signed with Android's default debug certificate.
          For production releases, a proper signing configuration is needed.
          
        files: apks/*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}