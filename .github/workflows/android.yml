name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
    
    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Gradle
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'buildSrc/**/*.kt') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Kotlin
    - name: Cache Kotlin/Native
      uses: actions/cache@v4
      with:
        path: |
          ~/.konan
        key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-konan-
    
    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ build outputs (–¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏)
    - name: Cache build outputs
      uses: actions/cache@v4
      with:
        path: |
          app/build
          build
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    # –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    - name: Clean build if needed
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -E '(backup_rules\.xml|data_extraction_rules\.xml|proguard-rules\.pro)'; then
          echo "Critical files changed, cleaning build..."
          ./gradlew clean
        fi
    
    # –°–±–æ—Ä–∫–∞ —Å –≤—ã–≤–æ–¥–æ–º –æ—à–∏–±–æ–∫ –≤ —Ñ–∞–π–ª
    - name: Build with Gradle
      id: build
      continue-on-error: true
      run: |
        set +e
        ./gradlew assembleRelease --stacktrace --no-daemon --warning-mode all 2>&1 | tee build_log.txt
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        echo "build_exit_code=$BUILD_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $BUILD_EXIT_CODE
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –∏–∑ –ª–æ–≥–∞
    - name: Extract errors
      if: always()
      run: |
        if [ -f build_log.txt ]; then
          echo "## üîç Build Errors Summary" > build_errors.txt
          echo "" >> build_errors.txt
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
          grep -A 5 "^> Task.*FAILED$" build_log.txt >> build_errors.txt 2>/dev/null || true
          grep -A 10 "FAILURE: Build failed" build_log.txt >> build_errors.txt 2>/dev/null || true
          grep "Error:" build_log.txt >> build_errors.txt 2>/dev/null || true
          
          # Lint –æ—à–∏–±–∫–∏
          if grep -q "lintVitalRelease FAILED" build_log.txt; then
            echo "" >> build_errors.txt
            echo "## üìã Lint Errors" >> build_errors.txt
            grep -A 20 "Error:" build_log.txt | grep -E "(Error:|Explanation)" >> build_errors.txt 2>/dev/null || true
          fi
          
          # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç–æ–π, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–± —É—Å–ø–µ—Ö–µ
          if [ ! -s build_errors.txt ]; then
            echo "‚úÖ No errors found - Build successful!" > build_errors.txt
          fi
        fi
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build_log.txt
          build_errors.txt
          app/build/reports/
        retention-days: 7
    
    # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –æ—à–∏–±–∫–∞–º–∏ –≤ PR
    - name: Comment PR with errors
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let errorContent = '‚ùå **Build Failed**\n\n';
          
          if (fs.existsSync('build_errors.txt')) {
            const errors = fs.readFileSync('build_errors.txt', 'utf8');
            errorContent += '```\n' + errors.substring(0, 60000) + '\n```\n';
            errorContent += '\nüì• Full logs available in artifacts';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: errorContent
          });
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—Ö–∞ —Å–±–æ—Ä–∫–∏
    - name: Check build status
      if: steps.build.outputs.build_exit_code != '0'
      run: |
        echo "‚ùå Build failed with exit code ${{ steps.build.outputs.build_exit_code }}"
        echo "üìã Check build_errors.txt in artifacts for details"
        exit 1
    
    - name: Prepare APKs for Release
      if: success()
      run: |
        mkdir -p apks
        
        RELEASE_APK=""
        if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          RELEASE_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
        elif [ -f app/build/outputs/apk/release/app-release.apk ]; then
          RELEASE_APK="app/build/outputs/apk/release/app-release.apk"
        fi
        
        if [ -n "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" apks/DocumentScanner-v${{ github.run_number }}-release.apk
          echo "‚úÖ APK prepared: DocumentScanner-v${{ github.run_number }}-release.apk"
          ls -lh apks/
        else
          echo "‚ö†Ô∏è No APK found"
          exit 1
        fi
    
    - name: Create Release
      if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: DocumentScanner v1.0.${{ github.run_number }}
        body: |
          ## üì± DocumentScanner v1.0.${{ github.run_number }}
          
          **Commit:** `${{ github.sha }}`
          **Build #:** ${{ github.run_number }}
          **Build time:** Optimized with caching
          
          ### üì¶ Downloads
          - Release APK included below
          
          ### üîß Changes
          ${{ github.event.head_commit.message }}
          
        files: apks/*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}