name: Android Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v2
        
    - name: Make gradlew executable
      run: chmod +x gradlew
      
    - name: Build with Gradle Wrapper
      run: ./gradlew tasks || echo "Gradle wrapper check failed"
      
    - name: Build Debug APK
      id: build_debug
      run: |
        ./gradlew assembleDebug --stacktrace > build-debug.log 2>&1 || true
        BUILD_STATUS=$?
        echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Build Release APK
      id: build_release
      run: |
        ./gradlew assembleRelease --stacktrace > build-release.log 2>&1 || true
        BUILD_STATUS=$?
        echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Extract compilation errors
      if: always()
      run: |
        cat > compilation-errors.md << 'EOF'
        # Build Logs - Run #${{ github.run_number }}
        
        **Repository:** ${{ github.repository }}
        **Branch:** ${{ github.ref_name }}
        **Commit:** `${{ github.sha }}`
        **Date:** $(date -u)
        
        ## ðŸ› Debug Build
        EOF
        
        if [ "${{ steps.build_debug.outputs.status }}" = "0" ]; then
          echo "âœ… **Status:** SUCCESS" >> compilation-errors.md
        else
          echo "âŒ **Status:** FAILED" >> compilation-errors.md
          echo "" >> compilation-errors.md
          echo "### Errors:" >> compilation-errors.md
          echo '```' >> compilation-errors.md
          cat build-debug.log | head -100 >> compilation-errors.md
          echo '```' >> compilation-errors.md
        fi
        
        cat >> compilation-errors.md << 'EOF'
        
        ## ðŸš€ Release Build
        EOF
        
        if [ "${{ steps.build_release.outputs.status }}" = "0" ]; then
          echo "âœ… **Status:** SUCCESS" >> compilation-errors.md
        else
          echo "âŒ **Status:** FAILED" >> compilation-errors.md
          echo "" >> compilation-errors.md
          echo "### Errors:" >> compilation-errors.md
          echo '```' >> compilation-errors.md
          cat build-release.log | head -100 >> compilation-errors.md
          echo '```' >> compilation-errors.md
        fi
        
    - name: Upload logs to Gist
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const content = fs.readFileSync('compilation-errors.md', 'utf8');
          
          try {
            const gist = await github.rest.gists.create({
              description: `Build logs - Run #${context.runNumber}`,
              public: false,
              files: {
                'build-log.md': { content: content }
              }
            });
            
            console.log(`ðŸ“ Logs: ${gist.data.html_url}`);
            core.summary.addLink('View Build Logs', gist.data.html_url);
            await core.summary.write();
          } catch (error) {
            console.log('Failed to create gist');
            console.log(content);
          }
      
    - name: Find APKs
      id: find_apks
      if: always()
      run: |
        mkdir -p apk-output
        find . -name "*.apk" -type f
        
        DEBUG_APK=$(find . -path "*/debug/*.apk" | head -1)
        RELEASE_APK=$(find . -path "*/release/*.apk" | head -1)
        
        if [ -n "$DEBUG_APK" ]; then
          cp "$DEBUG_APK" "apk-output/app-debug.apk"
          echo "debug_found=true" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" "apk-output/app-release.apk"
          echo "release_found=true" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$DEBUG_APK" ] || [ -n "$RELEASE_APK" ]; then
          echo "any_apk=true" >> $GITHUB_OUTPUT
          ls -lh apk-output/
        else
          echo "any_apk=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      if: steps.find_apks.outputs.any_apk == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Release v1.0.${{ github.run_number }}
        body: |
          ## ðŸ“± Build #${{ github.run_number }}
          
          **Commit:** `${{ github.sha }}`
          **Branch:** `${{ github.ref_name }}`
        files: apk-output/*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}