name: Android CI (Smart Logs)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Cache Gradle Wrapper
      uses: actions/cache@v4
      with:
        path: ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: ${{ runner.os }}-gradle-wrapper-
    
    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/daemon
          ~/.konan
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
        restore-keys: ${{ runner.os }}-gradle-
    
    - name: Cache Build Output
      uses: actions/cache@v4
      with:
        path: |
          build-cache
          .gradle
          app/build
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: ${{ runner.os }}-build-
    
    - name: Configure Gradle
      run: |
        mkdir -p $HOME/.gradle
        cat > $HOME/.gradle/gradle.properties << EOF
        org.gradle.caching=true
        org.gradle.parallel=true
        org.gradle.daemon=true
        org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1536m -XX:+UseG1GC
        org.gradle.configuration-cache=true
        org.gradle.vfs.watch=true
        android.useAndroidX=true
        kotlin.incremental=true
        EOF
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Clean build
      run: ./gradlew clean --no-daemon --stacktrace
    
    # ‚úÖ –ù–û–í–û–ï: Build —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫
    - name: Build APKs with Error Logging
      id: build
      run: |
        set +e  # –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ –æ—à–∏–±–∫–µ
        
        echo "üî® Starting build..."
        
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–≤–æ–¥ –≤ —Ñ–∞–π–ª
        ./gradlew assembleDebug assembleRelease \
          --parallel \
          --build-cache \
          --configuration-cache \
          --max-workers=4 \
          --stacktrace \
          -Dorg.gradle.workers.max=4 \
          -Dkotlin.compiler.execution.strategy=in-process \
          > build.log 2>&1
        
        BUILD_EXIT_CODE=$?
        
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "‚ùå Build failed with exit code $BUILD_EXIT_CODE"
          echo "build_status=failed" >> $GITHUB_OUTPUT
          
          # ‚úÖ –ò–∑–≤–ª–µ–∫–∞–µ–º –¢–û–õ–¨–ö–û –û–®–ò–ë–ö–ò –∏–∑ –ª–æ–≥–∞
          echo "## üî¥ Compilation Errors" > errors.txt
          echo "" >> errors.txt
          
          # KSP –æ—à–∏–±–∫–∏
          grep -A 5 "e: \[ksp\]" build.log >> errors.txt 2>/dev/null || true
          
          # Kotlin compilation errors
          grep -A 3 "e: file://" build.log >> errors.txt 2>/dev/null || true
          
          # Task failed
          grep -A 10 "Task.*failed" build.log >> errors.txt 2>/dev/null || true
          
          # Execution failed
          grep -B 3 -A 5 "Execution failed for task" build.log >> errors.txt 2>/dev/null || true
          
          # FAILURE: Build failed
          grep -A 20 "FAILURE: Build failed" build.log >> errors.txt 2>/dev/null || true
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
          ERROR_COUNT=$(grep -c "^e:" build.log 2>/dev/null || echo "0")
          echo "üìä Found $ERROR_COUNT error lines"
          
          # –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å GitHub Actions
          echo "### ‚ùå Build Failed"
          echo ""
          echo "\`\`\`"
          head -n 100 errors.txt
          echo "\`\`\`"
          
          exit 1
        else
          echo "‚úÖ Build successful"
          echo "build_status=success" >> $GITHUB_OUTPUT
        fi
    
    # ‚úÖ –ù–û–í–û–ï: Upload —Ç–æ–ª—å–∫–æ –ª–æ–≥–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏ (–µ—Å–ª–∏ —Å–±–æ—Ä–∫–∞ —É–ø–∞–ª–∞)
    - name: Upload Error Logs
      if: failure() && steps.build.outputs.build_status == 'failed'
      uses: actions/upload-artifact@v4
      with:
        name: build-error-logs
        path: |
          errors.txt
          build/reports/kotlin-build/*.txt
        retention-days: 7
        if-no-files-found: ignore
    
    # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö APK
    - name: Verify Build Output
      if: success()
      run: |
        echo "üì¶ Checking built APKs..."
        find app/build/outputs/apk -type f -name "*.apk" -exec ls -lh {} \;
    
    # ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ APK –¥–ª—è —Ä–µ–ª–∏–∑–∞
    - name: Prepare APKs for Release
      if: success()
      run: |
        mkdir -p apks
        
        # Debug APK
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          cp app/build/outputs/apk/debug/app-debug.apk \
             apks/DocumentScanner-v${{ github.run_number }}-debug.apk
          echo "‚úÖ Debug: $(ls -lh apks/DocumentScanner-v${{ github.run_number }}-debug.apk | awk '{print $5}')"
        fi
        
        # Release APK
        RELEASE_APK=""
        if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          RELEASE_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
        elif [ -f app/build/outputs/apk/release/app-release.apk ]; then
          RELEASE_APK="app/build/outputs/apk/release/app-release.apk"
        fi
        
        if [ -n "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" apks/DocumentScanner-v${{ github.run_number }}-release.apk
          echo "‚úÖ Release: $(ls -lh apks/DocumentScanner-v${{ github.run_number }}-release.apk | awk '{print $5}')"
        fi
        
        ls -lh apks/
    
    # ‚úÖ Upload APK (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–µ)
    - name: Upload APK Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: apk-builds
        path: apks/*.apk
        retention-days: 7
    
    # ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
    - name: Create Release
      if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: DocumentScanner v1.0.${{ github.run_number }}
        body: |
          ## üì± DocumentScanner v1.0.${{ github.run_number }}
          
          ### ‚ö° Build Info
          - **Commit:** `${{ github.sha }}`
          - **Branch:** `${{ github.ref_name }}`
          - **Build #:** ${{ github.run_number }}
          - **Gradle:** 8.11.1
          - **JDK:** 21
          
          ### üì• Installation
          1. Download APK
          2. Uninstall old version
          3. Install new APK
          4. Enable "Unknown sources" if needed
          
          ### üì¶ Available Versions
          - **Debug APK** - with debug info
          - **Release APK** - optimized (R8/ProGuard)
          
        files: apks/*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ‚úÖ Cleanup
    - name: Cleanup
      if: always()
      run: ./gradlew --stop || true