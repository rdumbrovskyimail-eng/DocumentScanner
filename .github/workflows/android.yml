name: Android Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v2
        
    - name: Make gradlew executable
      run: chmod +x gradlew
      
    - name: Build with Gradle Wrapper
      run: ./gradlew tasks || echo "Gradle wrapper check failed"
      
    - name: Build Debug APK
      id: build_debug
      run: |
        ./gradlew assembleDebug --stacktrace > build-debug.log 2>&1 || true
        BUILD_STATUS=$?
        echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Build Release APK
      id: build_release
      run: |
        ./gradlew assembleRelease --stacktrace > build-release.log 2>&1 || true
        BUILD_STATUS=$?
        echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Extract compilation errors
      if: always()
      run: |
        cat > compilation-errors.md << 'EOF'
        # Build Logs - Run #${{ github.run_number }}
        
        **Repository:** ${{ github.repository }}
        **Branch:** ${{ github.ref_name }}
        **Commit:** `${{ github.sha }}`
        **Date:** $(date -u)
        
        ## ðŸ› Debug Build
        EOF
        
        if [ "${{ steps.build_debug.outputs.status }}" = "0" ]; then
          echo "âœ… **Status:** SUCCESS" >> compilation-errors.md
        else
          echo "âŒ **Status:** FAILED" >> compilation-errors.md
          echo "" >> compilation-errors.md
          echo "### Errors:" >> compilation-errors.md
          echo '```' >> compilation-errors.md
          cat build-debug.log | head -100 >> compilation-errors.md
          echo '```' >> compilation-errors.md
        fi
        
        cat >> compilation-errors.md << 'EOF'
        
        ## ðŸš€ Release Build
        EOF
        
        if [ "${{ steps.build_release.outputs.status }}" = "0" ]; then
          echo "âœ… **Status:** SUCCESS" >> compilation-errors.md
        else
          echo "âŒ **Status:** FAILED" >> compilation-errors.md
          echo "" >> compilation-errors.md
          echo "### Errors:" >> compilation-errors.md
          echo '```' >> compilation-errors.md
          cat build-release.log | head -100 >> compilation-errors.md
          echo '```' >> compilation-errors.md
        fi
        
    - name: Upload logs to Gist
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const content = fs.readFileSync('compilation-errors.md', 'utf8');
          
          try {
            const gist = await github.rest.gists.create({
              description: `Build logs - Run #${context.runNumber}`,
              public: false,
              files: {
                'build-log.md': { content: content }
              }
            });
            
            console.log(`ðŸ“ Logs: ${gist.data.html_url}`);
            core.summary.addLink('View Build Logs', gist.data.html_url);
            await core.summary.write();
          } catch (error) {
            console.log('Failed to create gist');
            console.log(content);
          }
      
    - name: Find APKs
      id: find_apks
      if: always()
      run: |
        mkdir -p apk-output
        echo "Searching for APKs..."
        find . -name "*.apk" -type f
        
        DEBUG_APK=$(find . -path "*/debug/*.apk" -o -path "*/outputs/apk/debug/*.apk" | head -1)
        RELEASE_APK=$(find . -path "*/release/*.apk" -o -path "*/outputs/apk/release/*.apk" | head -1)
        
        if [ -n "$DEBUG_APK" ]; then
          echo "Found debug APK: $DEBUG_APK"
          cp "$DEBUG_APK" "apk-output/DocumentScanner-debug.apk"
          echo "debug_found=true" >> $GITHUB_OUTPUT
        else
          echo "debug_found=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$RELEASE_APK" ]; then
          echo "Found release APK: $RELEASE_APK"
          cp "$RELEASE_APK" "apk-output/DocumentScanner-release.apk"
          echo "release_found=true" >> $GITHUB_OUTPUT
        else
          echo "release_found=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$DEBUG_APK" ] || [ -n "$RELEASE_APK" ]; then
          echo "any_apk=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ APK files prepared:"
          ls -lh apk-output/
        else
          echo "any_apk=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ No APK files found"
        fi
        
    - name: Upload Debug APK
      if: steps.find_apks.outputs.debug_found == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: DocumentScanner-Debug-APK
        path: apk-output/DocumentScanner-debug.apk
        retention-days: 30
        
    - name: Upload Release APK
      if: steps.find_apks.outputs.release_found == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: DocumentScanner-Release-APK
        path: apk-output/DocumentScanner-release.apk
        retention-days: 90
        
    - name: Create Release
      if: steps.find_apks.outputs.any_apk == 'true' && github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: DocumentScanner v1.0.${{ github.run_number }}
        body: |
          ## ðŸ“± DocumentScanner Build #${{ github.run_number }}
          
          ### Build Information
          - **Commit:** `${{ github.sha }}`
          - **Branch:** `${{ github.ref_name }}`
          - **Date:** ${{ github.event.head_commit.timestamp }}
          - **Author:** @${{ github.actor }}
          
          ### ðŸ“¦ Available APKs
          ${{ steps.find_apks.outputs.debug_found == 'true' && '- âœ… Debug APK' || '- âŒ Debug APK (build failed)' }}
          ${{ steps.find_apks.outputs.release_found == 'true' && '- âœ… Release APK' || '- âŒ Release APK (build failed)' }}
          
          ### ðŸ“ Changes
          ${{ github.event.head_commit.message }}
          
          ### â¬‡ï¸ Download
          - **Debug APK**: For testing and development
          - **Release APK**: Optimized production build
          
          > ðŸ’¡ **Note:** Release APK is unsigned. You may need to enable "Install from Unknown Sources" on your device.
        files: apk-output/*.apk
        fail_on_unmatched_files: false
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Build Type | Status | APK |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|-----|" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.build_debug.outputs.status }}" = "0" ]; then
          DEBUG_STATUS="âœ… Success"
        else
          DEBUG_STATUS="âŒ Failed"
        fi
        
        if [ "${{ steps.build_release.outputs.status }}" = "0" ]; then
          RELEASE_STATUS="âœ… Success"
        else
          RELEASE_STATUS="âŒ Failed"
        fi
        
        if [ "${{ steps.find_apks.outputs.debug_found }}" = "true" ]; then
          DEBUG_APK="âœ… Available"
        else
          DEBUG_APK="âŒ Not found"
        fi
        
        if [ "${{ steps.find_apks.outputs.release_found }}" = "true" ]; then
          RELEASE_APK="âœ… Available"
        else
          RELEASE_APK="âŒ Not found"
        fi
        
        echo "| Debug | $DEBUG_STATUS | $DEBUG_APK |" >> $GITHUB_STEP_SUMMARY
        echo "| Release | $RELEASE_STATUS | $RELEASE_APK |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.find_apks.outputs.any_apk }}" = "true" ]; then
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "APK files are available in the workflow artifacts and release section." >> $GITHUB_STEP_SUMMARY
        fi